name: Deploy to EC2

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MY_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy on EC2 (ultra-diagnostic)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          APP_DIR:  ${{ secrets.APP_DIR }}
          BRANCH:   ${{ github.ref_name }}
          REPO:     git@github.com:${{ github.repository }}.git
        run: |
          set -euo pipefail
          echo "[LOCAL] whoami: $(whoami)"
          echo "[LOCAL] git version: $(git --version)"
          echo "[LOCAL] ssh-agent keys:"
          ssh-add -l || true

          echo "[LOCAL] Starting SSH to $SSH_USER@$SSH_HOST"
          # -vvv: verbose, -tt: force TTY so we see prompts/errors, -o BatchMode=yes: fail fast on auth issues
          ssh -vvv -tt -o BatchMode=yes -o StrictHostKeyChecking=yes "$SSH_USER@$SSH_HOST" bash -s <<'REMOTE'
          set -euxo pipefail

          echo "[REMOTE] whoami: $(whoami)"
          echo "[REMOTE] hostname: $(hostname)"
          echo "[REMOTE] pwd: $(pwd)"
          echo "[REMOTE] git version: $(git --version || true)"
          echo "[REMOTE] APP_DIR: ${APP_DIR:-<unset>}  BRANCH: ${BRANCH:-<unset>}  REPO: ${REPO:-<unset>}"

          # 환경변수 전달 확인
          if [ -z "${APP_DIR:-}" ] || [ -z "${BRANCH:-}" ] || [ -z "${REPO:-}" ]; then
            echo "[ERROR] Missing required env (APP_DIR/BRANCH/REPO)"; exit 2;
          fi

          mkdir -p "$APP_DIR"
          cd "$APP_DIR"

          if [ ! -d .git ]; then
            echo "[REMOTE] No .git -> cloning repo $REPO"
            git clone "$REPO" .
          fi

          echo "[REMOTE] git remote -v"
          git remote -v || true

          echo "[REMOTE] Ensuring origin exists"
          git remote get-url origin >/dev/null 2>&1 || git remote add origin "$REPO"

          echo "[REMOTE] Testing GitHub auth from server (ssh -T git@github.com)"
          ssh -T git@github.com || true

          echo "[REMOTE] Fetch origin"
          git fetch origin

          if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            git checkout "$BRANCH"
          else
            echo "[REMOTE] Creating local branch from origin/$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
          fi

          echo "[REMOTE] Hard reset to origin/$BRANCH"
          git reset --hard "origin/$BRANCH"

          echo "[REMOTE] Submodules (if any)"
          git submodule update --init --recursive || true

          echo "[REMOTE] List files"
          ls -al

          if [ ! -f ./deploy.sh ]; then
            echo "[ERROR] deploy.sh not found in $(pwd)"
            exit 3
          fi

          echo "[REMOTE] Ensure deploy.sh is executable"
          chmod +x ./deploy.sh || true

          echo "[REMOTE] Run deploy.sh with bash -x"
          bash -x ./deploy.sh
          REMOTE
          rc=$?
          echo "[LOCAL] SSH finished with exit code: $rc"
          exit $rc
