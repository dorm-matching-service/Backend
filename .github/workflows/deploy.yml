name: Deploy to EC2

on:
  push:
    branches: ['main'] # main에 푸시될 때만 실행

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MY_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on EC2
  env:
    SSH_HOST: ${{ secrets.SSH_HOST }}
    SSH_USER: ${{ secrets.SSH_USER }}
    APP_DIR: ${{ secrets.APP_DIR }}
    BRANCH: ${{ github.ref_name }} # e.g. main
    REPO: git@github.com:${{ github.repository }}.git
  run: |
    set -e
    ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "set -euxo pipefail; \
      echo '[INFO] APP_DIR:' \"$APP_DIR\"; \
      echo '[INFO] BRANCH:' \"$BRANCH\"; \
      mkdir -p \"$APP_DIR\"; \
      cd \"$APP_DIR\"; \
      if [ ! -d .git ]; then \
        echo '[INFO] No .git found. Cloning...'; \
        git clone \"$REPO\" .; \
      fi; \
      echo '[INFO] git status:'; git status || true; \
      echo '[INFO] git remote -v:'; git remote -v || true; \
      echo '[INFO] Ensure origin exists'; \
      git remote get-url origin >/dev/null 2>&1 || git remote add origin \"$REPO\"; \
      echo '[INFO] Fetch origin'; git fetch origin || (echo '[ERROR] git fetch failed'; exit 128); \
      if git show-ref --verify --quiet refs/heads/\"$BRANCH\"; then \
        git checkout \"$BRANCH\"; \
      else \
        echo '[INFO] Create local branch from origin'; \
        git checkout -B \"$BRANCH\" \"origin/$BRANCH\"; \
      fi; \
      echo '[INFO] Hard reset to origin/$BRANCH'; \
      git reset --hard \"origin/$BRANCH\"; \
      echo '[INFO] Update submodules (if any)'; \
      git submodule update --init --recursive || true; \
      echo '[INFO] Ensure deploy.sh is executable'; \
      chmod +x ./deploy.sh || true; \
      echo '[INFO] Run deploy.sh'; \
      ./deploy.sh \
    "
