- name: Deploy on EC2 (diagnostic)
  env:
    SSH_HOST: ${{ secrets.SSH_HOST }}
    SSH_USER: ${{ secrets.SSH_USER }}
    APP_DIR: /home/ubuntu/apps/backend
    BRANCH: ${{ github.ref_name }}
    REPO: git@github.com:${{ github.repository }}.git
  run: |
    set -ux
    echo "[LOCAL] whoami: $(whoami)"
    echo "[LOCAL] git version: $(git --version)"

    ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" 'bash -se' <<'EOSSH'
    set -euxo pipefail

    echo "[REMOTE] whoami: $(whoami)"
    echo "[REMOTE] APP_DIR: $APP_DIR  BRANCH: $BRANCH  REPO: $REPO"

    mkdir -p "$APP_DIR"
    cd "$APP_DIR"

    if [ ! -d .git ]; then
      echo "[REMOTE] No .git -> cloning repo"
      git clone "$REPO" .
    fi

    git remote set-url origin "$REPO"
    git fetch --tags --force --prune origin

    if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
      git checkout "$BRANCH"
    else
      echo "[REMOTE] Creating local branch from origin/$BRANCH"
      git checkout -B "$BRANCH" "origin/$BRANCH"
    fi

    echo "[REMOTE] Hard reset to origin/$BRANCH"
    git reset --hard "origin/$BRANCH"

    git submodule update --init --recursive || true
    ls -al

    if [ ! -f ./deploy.sh ]; then
      echo "[ERROR] deploy.sh not found in $(pwd)"
      exit 1
    fi

    chmod +x ./deploy.sh || true
    bash -x ./deploy.sh
    EOSSH
